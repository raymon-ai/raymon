=====================
Backend Configuration
=====================

The Raymon backend can be configured using a yaml orchestration file. The orchestration can be applied to a project by using the raymon api:

.. code-block:: python
  :linenos:

  with open("orchestration.yml", "r") as f:
      cfg = f.read()

  resp = api.orchestration_apply(project_id=project_id, cfg=cfg)


---------------------
Configuration options
---------------------
An example orchestration file can be seen here, and more information is given below.


.. code-block:: yaml
    :linenos:

    project_id: retinopathy
    version: draft
    settings:
        reducer_interval_s: 600 # 10 min
    actions:
        visualize: # On demand
            - name: show_request_data
            function: img2html
            inputs:
                data: request_data 
            params: null
            - name: show_normalized_data
            function: img2html
            inputs:
                data: flipped_data 
            params: null
            - name: show_resized_data
            function: img2html
            inputs:
                data: resized_data 
            params: null
            - name: show_pred
            function: native2html
            inputs:
                data: model_prediction 
            params: null
            - name: show_actual
            function: native2html
            inputs:
                data: actual 
            params: null

        reduce: # Will happen every 'reducer_interval_s' seconds
            - reducer_type: profile_reducer
            name: retinopathy@2.0.0

        map:
            - name: profile_eval
            mapper_type: profile_eval
            profile: retinopathy@2.0.0
            inputs:
                output: model_prediction # Ref
                actual: actual

    slices:
    - slicestr: "machine_id==a466a0ff-da21-4522-816e-08f89bd213b4"
    - slicestr: "machine_id==99d332c8-7064-44a8-a649-6c767bdb0ce9"
    - slicestr: "machine_id==de576b99-6aea-4802-990f-c34b1cecb248"
    - slicestr: "machine_id==fcb0d900-1a80-454f-84fc-7f4bdd1a3fbf"
    - slicestr: "machine_id==c098be7e-b09a-4584-ad7d-13b505e4b0f3"
    - slicestr: "machine_id==2f930ab2-3e8a-4869-a157-1bc5cd327244"
    - slicestr: "machine_id==1dbdc031-d805-4ffe-9800-e53aaddd02a7"
    - slicestr: "machine_id==9e2e7870-1de4-40b6-914a-8b4ebc7edc07"


Actions
---------------
The Raymon backend can execute so called actions. Actions are triggered by certain events like a time timeout or when a certain object (with a certain reference) is logged. There are 3 types of actions: mappers, reducers and visualizations.

.. note::
    We are working on much more actions (like webhooks for example) that will become available in future releases. Please `contact us <mailto:hello@raymon.ai>`_ for more information or feature requests.


Mappers
.........
Mappers are triggered when an object is logged and convert any data type into :class:`raymon.Tag`s. The mapper action can take one or more objects as input, and will get executed when all inputs are available on the backend. The only type of mapper that is currently supported is executing a :class:`raymon.ModelProfile`'s :meth:`raymon.ModelProfile.validate_eval` method, that has the model output and actuals as input, and generates the tags for the :class:`raymon.EvalComponent` of the profile. This is useful to combine the prediction and actual on the Raymon backend.


.. code-block:: yaml
    :linenos:

    map:
        - name: profile_eval  
        mapper_type: profile_eval  # Specify that this is a profile_eval mapper
        profile: retinopathy@2.0.0  # Profile identifier
        inputs:
            output: model_prediction  # object reference
            actual: actual  # Object reference


Reducers
..........
Reducer actions are executed every x seconds (60 seconds by default, unless configured otherwise in the :ref:`Reducer Interval` settings) and reduce tags from all traces that were processed since the last reduce into a fixed amount of values. For example, a reducer action can count the number of traces processed, or it can calculate the average duration of model prediction time, etc...

Currently, Raymon only supports profile reducers. These reducers will construct a profile of your production data based on the tags generated by the validation checks executed in your production code. Comparing this production profile with the training time profile is then used to generate issues and alerts.

As can be seen below, configuring a profile reducer is an easy 2 liner. The :code:`name` should be the profile identifier of the form `<profile_name>@<profile_version>`. 

.. code-block:: yaml
    :linenos:

    
    actions:
        reduce: # Will happen every 'reducer_interval_s' seconds
            - reducer_type: profile_reducer
            name: retinopathy@2.0.0




Visualizations
................

Visualization actions are executed only when a user inspects a given trace through the web UI. For every logged object of which the reference has a visualization configured, the web UI will show the visualization. Raymon currently supports viewing pandas DataFrame and Series and viewing images.


.. code-block:: yaml
    :linenos:


    actions:
        visualize: # On demand
            - name: show_request_data
            function: img2html
            inputs:
                data: request_data 
            params: null
            - name: show_normalized_data
            function: img2html
            inputs:
                data: flipped_data 
            params: null



Slices 
--------
Raymon allows you to define slices. All reduces will be executed globally and for every slice you have configured, so issues and alerts can be generated per slice. Slices are configured by giving them a :code:`slicestr` (see :ref:`Slices`) and an option :code:`name` and :code:`description`.

.. code-block:: yaml
    :linenos:
    
    slices:
    - slicestr: "machine_id==a466a0ff-da21-4522-816e-08f89bd213b4"
      name: "Your name"
      description: "Longer description"  
    - slicestr: "machine_id==99d332c8-7064-44a8-a649-6c767bdb0ce9"
    - slicestr: "machine_id==de576b99-6aea-4802-990f-c34b1cecb248"
    - slicestr: "machine_id==fcb0d900-1a80-454f-84fc-7f4bdd1a3fbf"
    - slicestr: "machine_id==c098be7e-b09a-4584-ad7d-13b505e4b0f3"
    - slicestr: "machine_id==2f930ab2-3e8a-4869-a157-1bc5cd327244"
    - slicestr: "machine_id==1dbdc031-d805-4ffe-9800-e53aaddd02a7"
    - slicestr: "machine_id==9e2e7870-1de4-40b6-914a-8b4ebc7edc07"



Settings
---------

Reducer Interval
.................
THis setting specifies the interval (in seconds) between reduce actions. 60 seconds by default. 
